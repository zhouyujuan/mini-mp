"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.transValidateResult=exports.getPageJSONVariableDecalearProperty=exports.checkComponentPath=exports.getUseExtendLib=exports.checkPagePathIsInIndependentSubpackage=exports.checkPagePathIsInSubPackage=exports.checkJSONFormat=void 0;const tools_1=require("../utils/tools"),config_1=require("../config"),path=require("path"),locales=require("../utils/locales/locales"),common_1=require("../utils/common"),config_2=require("../config"),lodash_1=require("lodash"),config_3=require("../config"),app_1=require("./app/app"),reactiveCache_1=require("./reactiveCache"),cache_1=require("../utils/cache");function checkJSONFormat(e,t){let o={};e||common_1.throwError({filePath:t,msg:"Empty file is NOT a valid json file",code:config_1.JSON_PARSE_ERR});try{o=JSON.parse(e)}catch(o){const n=tools_1.formatJSONParseErr({filePath:t,data:e,error:o});common_1.throwError({filePath:t,msg:n,code:config_1.JSON_PARSE_ERR})}return o}function checkPagePathIsInSubPackage(e,t){const{subPackages:o}=e;if(o)for(const e of o)if(0===t.indexOf(e.root))return e}function checkPagePathIsInIndependentSubpackage(e,t){const o=checkPagePathIsInSubPackage(e,t);if(o&&!0===o.independent)return o}function checkNodeModulesFile(e,t,o,n){let r=path.posix.join(o,"index")+".json",a=e.stat(t,r);return a&&a.isFile?r:(r=path.posix.join(o,n)+".json",a=e.stat(t,r),a&&a.isFile?r:(r=o+".json",a=e.stat(t,r),a&&a.isFile?r:""))}function resolveComponentPath(e,t,o,n){n=tools_1.normalizePath(n);let r=path.posix.join(o,n)+".json";const a=e.stat(t,r);if(a&&a.isFile)return n;let i=o.split(path.posix.sep);for(i=i.filter(e=>!!e),r="";i.length;){if(r=checkNodeModulesFile(e,t,path.posix.join(i.join(path.posix.sep),"miniprogram_npm",n),n),r)break;i.pop()}if(!r){r=checkNodeModulesFile(e,t,path.posix.join("miniprogram_npm",n),n)}return r&&(/\.json$/.test(r)&&(r=r.substring(0,r.length-5)),r=path.posix.relative(o,r)),r}exports.checkJSONFormat=checkJSONFormat,exports.checkPagePathIsInSubPackage=checkPagePathIsInSubPackage,exports.checkPagePathIsInIndependentSubpackage=checkPagePathIsInIndependentSubpackage;const _checkComponentPath=e=>{const{value:t,tips:o,project:n,root:r,relativePath:a}=e,i=path.posix.join(r,a);if(t.startsWith("plugin://")||t.startsWith("plugin-private://"))return t;const s=exports.getUseExtendLib(n,a);if(t.startsWith("/")){if(s.length){const e=s.map(e=>"/miniprogram_npm/"+e);let o=!1;for(const n of e)if(t.startsWith(n)){o=!0;break}if(o)return t}if(n.stat(r,t+".json"))return t;if(n.stat(r,t+"/index.json"))return t+"/index";common_1.throwError({msg:locales.config.NOT_FOUND.format(o),filePath:i})}if(t.startsWith(".")){if(t.startsWith("../")){const e=t.replace(/^(\.\.\/)+/,"");if(n.stat(r,path.posix.join(`/${e}.json`)))return t;if(n.stat(r,path.posix.join(`/${e}/index.json`)))return t+"/index"}if(n.stat(r,path.posix.join(path.posix.dirname(a),t+".json")))return t;if(n.stat(r,path.posix.join(path.posix.dirname(a),t+"/index.json")))return t+"/index";common_1.throwError({msg:locales.config.NOT_FOUND.format(`${o}: "${t}"`),filePath:i})}for(const e of s)if(t.startsWith(e))return"miniprogram-element"===e?`/miniprogram_npm/${e}/index`:t.replace(e,"/miniprogram_npm/"+e);const c=resolveComponentPath(n,r,path.posix.dirname(a),t);return c||common_1.throwError({msg:locales.config.NOT_FOUND.format(`${o}: "${t}"`),filePath:i}),c.startsWith(".")?c:"./"+c};exports.getUseExtendLib=reactiveCache_1.wrapCompileJSONFunc(cache_1.CACHE_KEY.USE_EXTEND_LIB,(function(e,t){var o;const n=app_1.getRawAppJSON(e);let r=[];if("[object Object]"===Object.prototype.toString.call(n.useExtendedLib)){const e=Object.keys(config_2.extendedLibMap),t=Object.keys(n.useExtendedLib).filter(t=>!e.includes(t));t.length&&common_1.throwError({msg:t.join(", ")+' is not allowed in ["useExtendedLib"]',filePath:"app.json"}),r=Object.keys(n.useExtendedLib||{}).filter(e=>n.useExtendedLib[e]).map(e=>config_2.extendedLibMap[e].packages),r=lodash_1.flattenDeep(r)}const a=checkPagePathIsInSubPackage(n,t);if(a&&a.useExtendedLib&&"[object Object]"===Object.prototype.toString.call(a.useExtendedLib)){const e=Object.keys(config_2.extendedLibMap),t=Object.keys(a.useExtendedLib).filter(t=>!e.includes(t));t.length&&common_1.throwError({msg:`${t.join(", ")} is not allowed in subPackages[${null===(o=n.subPackages)||void 0===o?void 0:o.indexOf(a)}]["useExtendedLib"]`,filePath:"app.json"});const i=Object.keys(a.useExtendedLib||{}).filter(e=>a.useExtendedLib[e]).map(e=>config_2.extendedLibMap[e].packages);r=lodash_1.uniq(r.concat(lodash_1.flattenDeep(i)))}return r}));const checkComponentPath=e=>{const{project:t,root:o,relativePath:n,inputJSON:r}=e,{usingComponents:a,componentGenerics:i}=r;if(a)for(const e in a){const r=a[e]||"";a[e]=_checkComponentPath({tips:`["usingComponents"]["${e}"]`,value:r,project:t,root:o,relativePath:n})}if(i)for(const e in i){const r="object"==typeof i[e],a=r?i[e].default:i[e];if(!a||"string"!=typeof a)continue;const s=_checkComponentPath({tips:`["componentGenerics"]["${e}"]`,value:a,project:t,root:o,relativePath:n});r?i[e].default=s:i[e]=s}};function getPageJSONVariableDecalearProperty(e){const{windowPropertWhiteList:t}=config_3.jsonVariablePropertyWhiteList;let o=[];return"[object Object]"===Object.prototype.toString.call(e)&&(o=o.concat(Object.keys(e).filter(e=>t.includes(e)).map(t=>({property:`["${t}"]`,value:e[t]})).filter(e=>e.value.startsWith("@")))),o}function transValidateResult(e){return e.error.map(e=>"type"===e.errorType||"enum"===e.errorType||"anyOf"===e.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([e.errorProperty,e.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([e.requireProperty])).join("\n")}exports.checkComponentPath=checkComponentPath,exports.getPageJSONVariableDecalearProperty=getPageJSONVariableDecalearProperty,exports.transValidateResult=transValidateResult;
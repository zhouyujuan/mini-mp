"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mergeThemeJSONToPageJSON=exports.mergeThemeJSONToAppJSON=exports.checkThemeJSON=exports.getPluginThemeLocation=exports.getThemeLocation=void 0;const path=require("path"),lodash_1=require("lodash"),tools_1=require("../utils/tools"),projectconfig_1=require("./projectconfig"),locales=require("../utils/locales/locales"),common_1=require("../utils/common"),common_2=require("./common"),cache_1=require("../utils/cache"),app_1=require("./app/app"),{schemaValidate:schemaValidate}=require("../validate/schemaValidate"),_=require("lodash"),config_1=require("../config"),plugin_1=require("../json/plugin/plugin"),reactiveCache_1=require("./reactiveCache");async function getPluginThemeLocation(e){return(await plugin_1.getDevPluginJSON(e)).themeLocation||null}function checkThemeJSON(e,o){const{isPlugin:t}=o;return t?originCheckThemeJSONForPlugin(e,o):originCheckThemeJSONForMiniProgram(e,o)}exports.getThemeLocation=reactiveCache_1.wrapCompileJSONFunc(cache_1.CACHE_KEY.APP_JSON_THEME_LOCATION,(function(e){const o=app_1.getRawAppJSON(e).themeLocation;return"[object Undefined]"!==Object.prototype.toString.call(o)?"string"==typeof o?(common_1.checkPath({value:o,tips:'["themeLocation"]',filePath:"app.json"}),o):(common_1.throwError({msg:locales.config.JSON_CONTENT_SHOULD_BE.format('appJSON["themeLocation"]',"string"),filePath:"app.json"}),null):null})),exports.getPluginThemeLocation=getPluginThemeLocation,exports.checkThemeJSON=checkThemeJSON;const originCheckThemeJSONForMiniProgram=reactiveCache_1.wrapCompileJSONFunc(cache_1.CACHE_KEY.THEME_JSON,originCheckThemeJSON),originCheckThemeJSONForPlugin=reactiveCache_1.wrapCompileJSONFunc(cache_1.CACHE_KEY.PLUGIN_THEME_JSON,originCheckThemeJSON);function originCheckThemeJSON(e,o){const{themeLocation:t,isPlugin:r}=o,i=projectconfig_1.getProjectConfigJSON(e),c=r?i.pluginRoot:i.miniprogramRoot,n=tools_1.normalizePath(path.posix.join(c||"",t));e.stat("",n)||common_1.throwError({msg:locales.config.FILE_NOT_FOUND.format(n),filePath:"app.json"});const a=e.getFile("",n),s=common_1.checkUTF8(a,n);let l=common_2.checkJSONFormat(s,n);const h=schemaValidate("theme",l);if(h.error.length){const e=h.error.map(e=>"type"===e.errorType||"enum"===e.errorType||"anyOf"===e.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([e.errorProperty,e.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([e.requireProperty])).join("\n");common_1.throwError({msg:e,filePath:n})}return l}function mergeThemeJSONToAppJSON(e,o){const{windowPropertWhiteList:t,tabBarPropertyWhiteList:r,tabbarListItemPropertyWhiteList:i}=config_1.jsonVariablePropertyWhiteList,c=/^@/,n=_.cloneDeep(o.window||{}),a=_.cloneDeep(o.window||{});Object.keys(n).forEach(o=>{const r=n[o];if(c.test(r)){t.includes(o)||common_1.throwError({msg:""+locales.config.SHOULD_NOT_IN.format([r,o]),filePath:"app.json"});const i=r.slice(1);n[o]=e.light[i]||r,a[o]=e.dark[i]||r}});const s=lodash_1.cloneDeep(o),l=lodash_1.cloneDeep(o);if(s.window=n,l.window=a,o.tabBar&&o.tabBar.list&&o.tabBar.list.length){const t=_.cloneDeep(o.tabBar||{list:[]}),n=_.cloneDeep(o.tabBar||{list:[]});t.list&&t.list.length>0&&Object.keys(t).forEach(o=>{if("list"!==o){const i=t[o];if(c.test(i)){r.includes(o)||common_1.throwError({msg:""+locales.config.SHOULD_NOT_IN.format([i,o]),filePath:"app.json"});const c=i.slice(1);t[o]=e.light[c]||i,n[o]=e.dark[c]||i}}else t.list.forEach((o,r)=>{Object.keys(o).forEach(a=>{const s=o[a];if(c.test(s)){i.includes(a)||common_1.throwError({msg:""+locales.config.SHOULD_NOT_IN.format([s,a]),filePath:"app.json"});const o=s.slice(1);t.list[r][a]=e.light[o]||s,n.list[r][a]=e.dark[o]||s}})})}),l.tabBar=n,s.tabBar=t}return{appJSONLight:s,appJSONDark:l}}function mergeThemeJSONToPageJSON(e,o,t){const r=config_1.jsonVariablePropertyWhiteList.windowPropertWhiteList,i=_.cloneDeep(o||{}),c=_.cloneDeep(o||{}),n=/^@/;return Object.keys(o).forEach(a=>{const s=o[a];if(n.test(s)){const o=s.slice(1);r.includes(a)||common_1.throwError({msg:""+locales.config.SHOULD_NOT_IN.format([s,a]),filePath:t}),c[a]=e.light[o]||s,i[a]=e.dark[o]||s}}),{pageJSONDark:i,pageJSONLight:c}}exports.mergeThemeJSONToAppJSON=mergeThemeJSONToAppJSON,exports.mergeThemeJSONToPageJSON=mergeThemeJSONToPageJSON;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getExtJSON=void 0;const cache_1=require("../../utils/cache"),common_1=require("../common"),common_2=require("../../utils/common"),lodash_1=require("lodash"),tools_1=require("../../utils/tools"),path=require("path"),projectconfig_1=require("../projectconfig"),locales=require("../../utils/locales/locales"),{schemaValidate:schemaValidate}=require("../../validate/schemaValidate"),theme_1=require("../theme"),_app_1=require("./_app"),reactiveCache_1=require("../reactiveCache");function checkExtPages(e){const{project:o,inputJSON:r,filePath:a,miniprogramRoot:t}=e,{extPages:c}=r;if(c)for(const e in c){const r=c[e];if(r){r.navigationBarBackgroundColor&&!tools_1.isHexColor(r.navigationBarBackgroundColor)&&common_2.throwError({msg:`["extPages"]["${e}"]["navigationBarBackgroundColor"]: "${r.navigationBarBackgroundColor}" is not hexColor`,filePath:a}),r.backgroundColor&&!tools_1.isHexColor(r.backgroundColor)&&common_2.throwError({msg:`["extPages"]["${e}"]["backgroundColor"]: "${r.backgroundColor}" is not hexColor`,filePath:a});try{_app_1.checkComponentPath({project:o,miniprogramRoot:t,inputJSON:r,filePath:e+".json"})}catch(o){common_2.throwError({msg:`["extPages"]["${e}"]${o.message}`,filePath:a})}}}}exports.getExtJSON=reactiveCache_1.wrapCompileJSONFunc(cache_1.CACHE_KEY.EXT_JSON,(function(e,o=!1){const r=projectconfig_1.getProjectConfigJSON(e),{miniprogramRoot:a=""}=r,t=e.attrSync(),c=tools_1.normalizePath(path.posix.join(a,"ext.json"));if(!t||!t.platform)return e.stat(a,"ext.json")?{__warning__:locales.config.EXT_JSON_INVALID.format(e.appid,"https://developers.weixin.qq.com/miniprogram/dev/devtools/ext.html")}:void 0;if(!e.stat(a,"ext.json"))return;const n=e.getFile(a,"ext.json"),i=common_1.checkJSONFormat(common_2.checkUTF8(n,c),c);if(!i.extEnable)return{};const p=theme_1.getThemeLocation(e);let _={};p&&(_=theme_1.checkThemeJSON(e,{themeLocation:p}));const s=theme_1.mergeThemeJSONToAppJSON(_,i),l=schemaValidate("ext",s.appJSONLight),m=schemaValidate("ext",s.appJSONDark);if(l.warning&&(i.__warning__=locales.config.INVALID.format(l.warning)),m.warning&&(i.__warning__=locales.config.INVALID.format(m.warning)),l.error.length||m.error.length){const e=l.error.map(e=>"type"===e.errorType||"enum"===e.errorType||"anyOf"===e.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([e.errorProperty,e.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([e.requireProperty])),o=m.error.map(e=>"type"===e.errorType||"enum"===e.errorType||"anyOf"===e.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([e.errorProperty,e.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([e.requireProperty])),r=e.concat(o).join("\n");common_2.throwError({msg:r,filePath:c})}i.extAppid||common_2.throwError({msg:""+locales.config.EXT_APPID_SHOULD_NOT_BE_EMPTY,filePath:c});const h={filePath:c,project:e,miniprogramRoot:a,inputJSON:i},g=lodash_1.cloneDeep(h);g.inputJSON=s.appJSONLight,g.mode="light";const u=lodash_1.cloneDeep(h);return u.inputJSON=s.appJSONDark,u.mode="dark",_app_1.checkMainPkgPages(h),_app_1.checkMainPkgPages(h),_app_1.checkSubpackages(h),_app_1.checkTabbar(g),_app_1.checkTabbar(u),_app_1.checkWorkers(h),_app_1.checkFunctionalPages(h),_app_1.checkOpenLocationPagePath(h),_app_1.checkSitemapLocation(h),_app_1.checkPlugins(h),_app_1.checkWindow(g),_app_1.checkWindow(u),_app_1.checkComponentPath(h),checkExtPages(h),i}));
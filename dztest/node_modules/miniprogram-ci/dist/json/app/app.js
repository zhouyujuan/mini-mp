"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAppJSON=exports.getRawAppJSON=exports.checkAppJSON=void 0;const path=require("path"),locales=require("../../utils/locales/locales"),projectconfig_1=require("../projectconfig"),common_1=require("../../utils/common"),config_1=require("../../config"),common_2=require("../common"),cache_1=require("../../utils/cache"),lodash_1=require("lodash"),{schemaValidate:schemaValidate}=require("../../validate/schemaValidate"),_app_1=require("./_app"),tools_1=require("../../utils/tools"),theme_1=require("../theme"),reactiveCache_1=require("../reactiveCache");function transValidateResult(e){return e.error.map(e=>"type"===e.errorType||"enum"===e.errorType||"anyOf"===e.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([e.errorProperty,e.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([e.requireProperty])).join("\n")}function checkAppJSON(e){const{inputJSON:a}=e;let o=e.filePath;const r=theme_1.getThemeLocation(e.project);if(!r){const e=_app_1.getAppJSONVariableDecalearProperty(a);e.length&&common_1.throwError({msg:'appJSON["themeLocation"] is required because:\n'+e.map(e=>`"${e.value}" as variable was declared at ${o}:${e.property}`).join("\n"),filePath:o})}let t={light:{},dark:{}};r&&(t=theme_1.checkThemeJSON(e.project,{themeLocation:r}));const c=theme_1.mergeThemeJSONToAppJSON(t,a),p=_app_1.getAppJSONVariableDecalearProperty(c.appJSONLight);p.length&&common_1.throwError({msg:p.map(e=>`"${e.value}" as variable was declared at ${o}:${e.property}, but not found at ${r}["light"]`).join("\n"),filePath:o});const n=_app_1.getAppJSONVariableDecalearProperty(c.appJSONDark);n.length&&common_1.throwError({msg:n.map(e=>`"${e.value}" as variable was declared at ${o}:${e.property}, but not found at ${r}["dark"]`).join("\n"),filePath:o});const i=schemaValidate("app",c.appJSONLight),_=schemaValidate("app",c.appJSONDark);if(i.warning&&(a.__warning__=locales.config.INVALID.format(i.warning)),r&&_.warning&&(a.__warning__=locales.config.INVALID.format(_.warning)),i.error.length){const e=transValidateResult(i);r&&(o+=` or ${r}["light"]`),common_1.throwError({msg:e,filePath:o})}if(r&&_.error.length){const e=transValidateResult(_);r&&(o+=` or ${r}["dark"]`),common_1.throwError({msg:e,filePath:o})}const s=Object.assign(Object.assign({},e),{mode:"light",inputJSON:c.appJSONLight}),l=Object.assign(Object.assign({},e),{mode:"dark",inputJSON:c.appJSONDark});_app_1.checkMainPkgPages(e),_app_1.checkSubpackages(e),_app_1.checkTabbar(s),r&&_app_1.checkTabbar(l),_app_1.checkWorkers(e),_app_1.checkFunctionalPages(e),_app_1.checkOpenLocationPagePath(e),_app_1.checkSitemapLocation(e),_app_1.checkPlugins(e),_app_1.checkWindow(s),r&&_app_1.checkWindow(l),_app_1.checkComponentPath(e);const h=common_1.getAllPagesInfo(a);return _app_1.checkEntryPagePath(e,h),_app_1.checkPreloadRule(e,h),_app_1.checkTabbarPage(e),_app_1.checkMainPkgPageIsInSubpkg(e),_app_1.checkMainPkgPluginIsInSubPkg(e),_app_1.checkEntranceDeclare(e),a}exports.checkAppJSON=checkAppJSON,exports.getRawAppJSON=reactiveCache_1.wrapCompileJSONFunc(cache_1.CACHE_KEY.RAW_APP_JSON,(function(e){const a=projectconfig_1.getProjectConfigJSON(e),{miniprogramRoot:o=""}=a,r=tools_1.normalizePath(path.posix.join(o,"app.json"));e.stat(o,"app.json")||common_1.throwError({msg:locales.config.NOT_FOUND.format(r),code:config_1.FILE_NOT_FOUND,filePath:r});const t=e.getFile(o,"app.json");return common_2.checkJSONFormat(common_1.checkUTF8(t,r),r)})),exports.getAppJSON=reactiveCache_1.wrapCompileJSONFunc(cache_1.CACHE_KEY.APP_JSON,(function(e){const a=lodash_1.cloneDeep(exports.getRawAppJSON(e)),o=projectconfig_1.getProjectConfigJSON(e),{miniprogramRoot:r=""}=o;return checkAppJSON({project:e,miniprogramRoot:r,filePath:tools_1.normalizePath(path.posix.join(r,"app.json")),inputJSON:a}),a}));
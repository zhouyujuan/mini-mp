"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAppJSONVariableDecalearProperty=exports.mergeExtJSON=exports.checkEntranceDeclare=exports.checkComponentPath=exports.checkMainPkgPluginIsInSubPkg=exports.checkMainPkgPageIsInSubpkg=exports.checkTabbarPage=exports.checkEntryPagePath=exports.checkPreloadRule=exports.checkFunctionalPages=exports.checkNavigateToMiniProgramAppIdList=exports.checkPlugins=exports.checkSubpackages=exports.checkSitemapLocation=exports.checkMainPkgPages=exports.checkOpenLocationPagePath=exports.checkWorkers=exports.checkTabbar=exports.checkWindow=exports.checkPageExist=void 0;const _=require("lodash"),config_1=require("../../config"),common_1=require("../common"),common_2=require("../../utils/common"),config_2=require("../../config"),tools_1=require("../../utils/tools"),path=require("path"),locales=require("../../utils/locales/locales"),{schemaValidate:schemaValidate}=require("../../validate/schemaValidate"),common_3=require("../common"),config_3=require("../../config");function checkPageExist(o,e,t){const{miniprogramRoot:a,project:c,filePath:n}=o;c.stat(a,e+".wxml")||common_2.throwError({msg:locales.config.CORRESPONDING_FILE_NOT_FOUND.format(t,e+".wxml"),code:config_1.FILE_NOT_FOUND,filePath:n}),c.stat(a,e+".js")||common_2.throwError({msg:locales.config.CORRESPONDING_FILE_NOT_FOUND.format(t,e+".js"),code:config_1.FILE_NOT_FOUND,filePath:n})}function checkWindow(o){const{inputJSON:e,mode:t}=o;let a=""+o.filePath;e.themeLocation&&(a+=` or ${e.themeLocation}["${t}"]`);const c=[],{window:n}=e;n&&(void 0!==n.navigationBarBackgroundColor&&(tools_1.isHexColor(n.navigationBarBackgroundColor)||c.push(`["window"]["navigationBarBackgroundColor"]: "${n.navigationBarBackgroundColor}" is not hexColor`)),void 0!==n.backgroundColor&&(tools_1.isHexColor(n.backgroundColor)||c.push(`["window"]["backgroundColor"]: "${n.backgroundColor}" is not hexColor`)),c.length>0&&common_2.throwError({msg:c.join("\n"),filePath:a}))}function checkTabbar(o){const{project:e,miniprogramRoot:t,inputJSON:a,mode:c}=o;let n=""+o.filePath;a.themeLocation&&(n+=` or ${a.themeLocation}["${c}"]`);const{tabBar:r}=a,i=e.attrSync().setting;if(!r)return;const s=[];r.list.length<i.MinTabbarCount&&common_2.throwError({msg:locales.config.JSON_TABBAR_AT_LEAST.format(i.MinTabbarCount),filePath:n}),r.list.length>i.MaxTabbarCount&&common_2.throwError({msg:locales.config.JSON_TABBAR_AT_MOST.format(i.MaxTabbarCount),filePath:n});for(let o=0;o<r.list.length;o++){const a=r.list[o],c=a.pagePath;if(common_2.checkPath({value:c,tips:`["tabBar"]["list"][${o}]["pagePath"]`,filePath:n}),!c){s.push(locales.config.JSON_TABBAR_PATH_EMPTY.format(o));continue}c.indexOf("?")>=0&&s.push(locales.config.JSON_SHOULD_NOT_CONTAIN.format(`["tabBar"]["list"][${o}]["pagePath"]`,"?")),c.indexOf(".")>=0&&s.push(locales.config.JSON_SHOULD_NOT_CONTAIN.format(`["tabBar"]["list"][${o}]["pagePath"]`,"."));const l=[];a.iconPath&&(common_2.checkPath({value:a.iconPath,tips:`["tabBar"]["list"][${o}]["iconPath"]`,filePath:n,checkPathType:common_2.ECheckPathType.TAB_BAR_ICON}),l.push({name:"iconPath",path:a.iconPath})),a.selectedIconPath&&(common_2.checkPath({value:a.selectedIconPath,tips:`["tabBar"]["list"][${o}]["selectedIconPath"]`,filePath:n,checkPathType:common_2.ECheckPathType.TAB_BAR_ICON}),l.push({name:"selectedIconPath",path:a.selectedIconPath})),l.forEach(a=>{const c=e.stat(t,a.path);if(!c)return void s.push(locales.config.NOT_FOUND.format(`["tabBar"]["list"][${o}]["${a.name}"]: "${a.path}"`));if(c.isDirectory)return void s.push(locales.config.JSON_CONTENT_SHOULD_BE.format(`["tabBar"]["list"][${o}]["${a.name}"]`,locales.config.FILE));c.size>1024*i.MaxTabbarIconSize&&s.push(locales.config.JSON_TABBAR_ICON_MAX_SIZE.format([o,a.name,i.MaxTabbarIconSize]));const n=path.posix.extname(a.path);config_2.TABBAR_ICON_WHITE_LIST.indexOf(n)<0&&s.push(locales.config.JSON_TABBAR_ICON_EXT.format([o,a.name,config_2.TABBAR_ICON_WHITE_LIST.join("、")]))})}s.length>0&&common_2.throwError({msg:s.join("\n"),filePath:n})}function checkWorkers(o){const{project:e,miniprogramRoot:t,filePath:a,inputJSON:c}=o,{workers:n}=c;if(void 0===n)return;const r='["workers"]';""===n&&common_2.throwError({msg:locales.config.JSON_CONTENT_SHOULD_BE.format(r,locales.config.DIRECTORY),filePath:a}),common_2.checkPath({value:n,tips:r,filePath:a});const i=e.stat(t,n);i||common_2.throwError({msg:locales.config.JSON_CONTENT_SHOULD_BE.format([r,locales.config.DIRECTORY]),filePath:a}),i.isDirectory||common_2.throwError({msg:locales.config.JSON_CONTENT_SHOULD_BE.format([r,locales.config.DIRECTORY]),filePath:a}),c.workers=tools_1.normalizePath(n+"/")}function checkOpenLocationPagePath(o){const{filePath:e,inputJSON:t}=o,{openLocationPagePath:a}=t;if(void 0===a)return;const c='["openLocationPagePath"]';common_2.checkPath({value:a,tips:c,filePath:e}),checkPageExist(o,a,c)}exports.checkPageExist=checkPageExist,exports.checkWindow=checkWindow,exports.checkTabbar=checkTabbar,exports.checkWorkers=checkWorkers,exports.checkOpenLocationPagePath=checkOpenLocationPagePath;const checkMainPkgPages=o=>{const{filePath:e,inputJSON:t}=o,{pages:a}=t;if(!a)return;const c={};for(let t=0;t<a.length;t++){const n=a[t],r=`["pages"][${t}]`;common_2.checkPath({value:n,tips:r,filePath:e}),c[n]&&common_2.throwError({msg:locales.config.JSON_PAGES_REPEAT.format(`"${n}"`,'["pages"]'),filePath:e}),c[n]=!0,checkPageExist(o,n,r)}};function checkSitemapLocation(o){const{filePath:e,inputJSON:t}=o,{sitemapLocation:a}=t;if(void 0===a)return;const{project:c,miniprogramRoot:n}=o,r='["sitemapLocation"]';common_2.checkPath({value:a,tips:r,filePath:e});const i=c.stat(n,a);i&&!i.isDirectory||common_2.throwError({msg:locales.config.CORRESPONDING_FILE_NOT_FOUND.format(r,a),filePath:e});".json"!==path.posix.extname(a)&&common_2.throwError({msg:locales.config.EXT_SHOULD_BE_ERROR.format(r,".json"),filePath:e});const s=c.getFile(n,a),l=common_2.checkUTF8(s,a),g=common_1.checkJSONFormat(l,a),h=schemaValidate("sitemap",g);if(h.error.length){const o=h.error.map(o=>"type"===o.errorType||"enum"===o.errorType||"anyOf"===o.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([o.errorProperty,o.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([o.requireProperty])).join("\n");common_2.throwError({msg:o,filePath:a})}}function checkSubpackages(o){const{project:e,miniprogramRoot:t,filePath:a,inputJSON:c}=o;let n='["subPackages"]';c.subpackages&&(n='["subpackages"]',c.subPackages=c.subpackages,delete c.subpackages);const r=[];if(c.subPackages){const i=e.attrSync(),{setting:s}=i;c.subPackages.length>s.MaxSubPackageLimit&&common_2.throwError({msg:locales.config.EXCEED_LIMIT.format([n,s.MaxSubPackageLimit]),filePath:a});const l={},g={};for(let i=0;i<c.subPackages.length;i++){const s=c.subPackages[i],h=`${n}[${i}]`;if(common_2.checkPath({value:s.root,tips:`${n}[${i}]["root"]`,filePath:a}),s.root===config_2.MINI_PROGRAM_MAIN_PACKAGE_ROOT){r.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format(`${n}[${i}]["root"]`,config_2.MINI_PROGRAM_MAIN_PACKAGE_ROOT));continue}if(s.name){if(s.name===config_2.MINI_PROGRAM_MAIN_PACKAGE_ROOT){r.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format(`${n}[${i}]["name"]`,config_2.MINI_PROGRAM_MAIN_PACKAGE_ROOT));continue}if(g[s.name]){r.push(locales.config.SAME_ITEM.format(h,g[s.name],"name"));continue}g[s.name]=h}if(s.root=tools_1.normalizePath(s.root+"/"),l[s.root]){r.push(locales.config.SAME_ITEM.format(h,l[s.root],"root"));continue}l[s.root]=h;const p=e.stat(t,s.root);if(!p){r.push(locales.config.JSON_CONTENT_SHOULD_BE.format([`${n}[${i}]["root"]`,locales.config.DIRECTORY]));continue}if(!p.isDirectory){r.push(locales.config.JSON_CONTENT_SHOULD_BE.format([`${n}[${i}]["root"]`,locales.config.DIRECTORY]));continue}const _={};for(let e=0,t=s.pages.length;e<t;e++){const t=s.pages[e];common_2.checkPath({value:t,tips:`${n}[${i}]["pages"][${e}]`,filePath:a});const c=tools_1.normalizePath(path.posix.join(s.root,t));_[c]?r.push(locales.config.JSON_PAGES_REPEAT.format([`"${t}"`,`${n}[${i}]`])):(_[c]=!0,checkPageExist(o,c,`${n}[${i}]["pages"][${e}]`))}}r.length>0&&common_2.throwError({msg:r.join("\n"),filePath:a});for(let o=0;o<c.subPackages.length;o++){const e=c.subPackages[o];let t=-1;const a="/"+e.root;c.subPackages.forEach((e,c)=>{if(c!==o&&e.root){const o="/"+e.root;0===a.indexOf(o)&&(t=c)}}),-1===t||r.push(locales.config.JSON_SHOULD_NOT_CONTAIN.format(`${n}[${t}]["root"]`,`${n}[${o}]["root"]`))}r.length>0&&common_2.throwError({msg:r.join("\n"),filePath:a})}}function checkPlugins(o){const{filePath:e,inputJSON:t,project:a}=o,c=[],n=t.plugins||{};function r(o,e){const t=a.appid,n=a.type===config_2.COMPILE_TYPE.miniProgramPlugin;if(n||"dev"!==o.version)if(n)"dev"===o.version&&o.provider!==t?c.push(locales.config.JSON_CONTENT_SHOULD_BE.format(e+'["provider"]',`"${t}"`)):o.provider===t&&"dev"!==o.version&&c.push(locales.config.JSON_CONTENT_SHOULD_BE.format(e+'["version"]','"dev"'));else{if("dev"===o.version||"latest"===o.version||/^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/.test(o.version)||/^dev-[A-Za-z0-9]+$/.test(o.version))return!0;c.push(locales.config.JSON_CONTENT_SHOULD_BE.format([e+'["version"]',locales.config.TRIPLE_NUMBER_DOT]))}else c.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format(e+'["version"]',"dev")+"\n"+locales.config.PLEASE_CHOOSE_PLUGIN_MODE)}for(const o in n){r(n[o],`["plugins"]["${o}"]`)}t.subPackages&&t.subPackages.forEach((o,e)=>{if(!o.plugins)return;const t=`["subPackages"][${e}]`;for(const e in o.plugins){r(o.plugins[e],`${t}["plugins"]["${e}"]`)}}),c.length>0&&common_2.throwError({msg:c.join("\n"),filePath:e})}function checkNavigateToMiniProgramAppIdList(o){const{filePath:e,inputJSON:t,project:a}=o,c=[];if(t.navigateToMiniProgramAppIdList){const o=a.attrSync(),{appType:e=config_1.APP_TYPE.NORMAL,setting:n}=o;if(e!==config_1.APP_TYPE.NATIVE){const o=n&&n.NavigateMiniprogramLimit;t.navigateToMiniProgramAppIdList.length>o&&c.push(locales.config.EXCEED_LIMIT.format('["navigateToMiniProgramAppIdList"]',o))}}c.length>0&&common_2.throwError({msg:c.join("\n"),filePath:e})}function checkFunctionalPages(o){const{inputJSON:e}=o;if(e.functionalPages&&"object"!==tools_1.getType(e.functionalPages)){const o='["functionalPages"] 配置需要更新，详见文档: https://developers.weixin.qq.com/miniprogram/dev/framework/plugin/functional-pages.html';e.__warning__?e.__warning__=`${e.__warning__}\n${o}`:e.__warning__=o}}function checkPreloadRule(o,e){const{inputJSON:t,filePath:a}=o,{preloadRule:c,subPackages:n}=t;if(!c||!n)return;const r=[],i={},s={},l={};e.forEach(o=>{i[o.root]=!0,l[o.path]=!0,o.name&&(s[o.name]=!0)});for(const o in c){if(!l[o]&&!o.includes("__plugin__/")){r.push(locales.config.NOT_FOUND.format(`["preloadRule"]["${o}"]: ${locales.config.PAGE_PATH}`));continue}const e=c[o];for(let t=0,a=e.packages.length;t<a;t++){let a=e.packages[t];a!==config_2.MINI_PROGRAM_MAIN_PACKAGE_ROOT&&(s[a]||(a=tools_1.normalizePath(a+"/"),i[a]||r.push(locales.config.NOT_FOUND.format(`["preloadRule"]["${o}"]["packages"][${t}]: ${a}`))))}}r.length>0&&common_2.throwError({msg:r.join("\n"),filePath:a})}function checkEntryPagePath(o,e){const{inputJSON:t,filePath:a}=o,{entryPagePath:c}=t;if(!c)return;common_2.checkPath({value:c,tips:'["entryPagePath"]',filePath:a});let n=!1;for(const o of e)if(o.path===c){n=!0;break}n||common_2.throwError({msg:locales.config.JSON_ENTRY_PAGE_PATH_NOT_FOUND.format(["pages、subPackages","entryPagePath"]),filePath:a})}function checkTabbarPage(o){const{filePath:e,inputJSON:t}=o,{tabBar:a,pages:c=[]}=t;if(!a)return;const n=[];for(let o=0;o<a.list.length;o++){const e=a.list[o].pagePath;c.indexOf(e)<0&&n.push(`["tabBar"][${o}]["pagePath"]: "${e}" need in ["pages"]`)}n.length>0&&common_2.throwError({msg:n.join("\n"),filePath:e})}function checkMainPkgPageIsInSubpkg(o){const{filePath:e,inputJSON:t}=o,{subPackages:a,pages:c=[]}=t;if(!a)return;const n=[];for(let o=0;o<a.length;o++){const e=a[o];for(let t=0;t<c.length;t++){const a=c[t];0===a.indexOf(e.root)&&n.push(locales.config.SHOULD_NOT_IN.format([`["pages"][${t}]: "${a}"`,`["subPackages"][${o}]`]))}}n.length>0&&common_2.throwError({msg:n.join("\n"),filePath:e})}function checkMainPkgPluginIsInSubPkg(o){const{filePath:e,inputJSON:t}=o,{plugins:a={},subPackages:c}=t,n={},r={},i=[];for(const o in a){const e=a[o],t=`["plugins"]["${o}"]`;n[e.provider]?i.push(locales.config.SAME_ITEM.format(`["plugins"]["${o}"]`,n[e.provider].tips,"provider")):n[e.provider]=r[o]={provider:e.provider,version:e.version,alias:o,tips:t}}if(c)for(let o=0;o<c.length;o++){const e=c[o];if(e.plugins)for(const t in e.plugins){const a=`["subPackages"][${o}]["plugins"]`,c=e.plugins[t];n[c.provider]?i.push(locales.config.SAME_ITEM.format(`${a}["${t}"]`,n[c.provider].tips,"provider")):r[t]?i.push(locales.config.PLUGINS_SAME_ALIAS.format(`${a}["${t}"]`,r[t].tips)):n[c.provider]=r[t]={provider:c.provider,version:c.version,alias:c,tips:a}}}i.length>0&&common_2.throwError({msg:i.join("\n"),filePath:e})}function checkComponentPath(o){const{project:e,miniprogramRoot:t,filePath:a,inputJSON:c}=o;common_3.checkComponentPath({project:e,root:t,relativePath:path.posix.relative(t,a),inputJSON:c})}function checkEntranceDeclare(o){const e=o.inputJSON;if(!e.entranceDeclare||!e.entranceDeclare.locationMessage)return;let t=e.pages||[];e.subpackages&&(t=t.concat(e.subpackages.map(o=>o.pages.map(e=>o.root+e))),t=_.flattenDeep(t)),e.subPackages&&(t=t.concat(e.subPackages.map(o=>o.pages.map(e=>o.root+e))),t=_.flattenDeep(t));const a=[],c=e.entranceDeclare.locationMessage.path;void 0===c?a.push(locales.config.JSON_ENTRANCE_DECLARE_PATH_EMPTY.format([])):t.includes(c)||a.push(locales.config.JSON_ENTRANCE_DECLARE_PATH_ERR.format([c||"undefined"])),a.length>0&&common_2.throwError({msg:a.join("\n"),filePath:o.filePath})}function mergeExtJSON(o,e){if(e)for(const t in e)if("__warning__"!==t){if("extPages"!==t){if("plugins"===t||"supportedMaterials"===t){o[t]=e[t];continue}"object"===tools_1.getType(e[t])?"object"!==tools_1.getType(o[t])?o[t]=Object.assign({},e[t]):o[t]=Object.assign({},o[t]||{},e[t]):o[t]=e[t]}}else o.__warning__=o.__warning__?`${o.__warning__}、${e.__warning__}`:e.__warning__}function getAppJSONVariableDecalearProperty(o){const{windowPropertWhiteList:e,tabBarPropertyWhiteList:t,tabbarListItemPropertyWhiteList:a}=config_3.jsonVariablePropertyWhiteList;let c=[];return"[object Object]"===Object.prototype.toString.call(o.window)&&(c=c.concat(Object.keys(o.window).filter(o=>e.includes(o)).map(e=>({property:`["window"]["${e}"]`,value:o.window[e]})).filter(o=>o.value.startsWith("@")))),"[object Object]"===Object.prototype.toString.call(o.tabBar)&&(c=c.concat(Object.keys(o.tabBar).filter(o=>t.includes(o)).map(e=>({property:`["tabBar"]["${e}"]`,value:o.tabBar[e]})).filter(o=>o.value.startsWith("@"))),Array.isArray(o.tabBar.list)&&o.tabBar.list.forEach((e,t)=>{c=c.concat(Object.keys(e).filter(o=>a.includes(o)).map(e=>({property:`["tabBar"]["list"][${t}]["${e}"]`,value:o.tabBar.list[t][e]})).filter(o=>o.value.startsWith("@")))})),c}exports.checkMainPkgPages=checkMainPkgPages,exports.checkSitemapLocation=checkSitemapLocation,exports.checkSubpackages=checkSubpackages,exports.checkPlugins=checkPlugins,exports.checkNavigateToMiniProgramAppIdList=checkNavigateToMiniProgramAppIdList,exports.checkFunctionalPages=checkFunctionalPages,exports.checkPreloadRule=checkPreloadRule,exports.checkEntryPagePath=checkEntryPagePath,exports.checkTabbarPage=checkTabbarPage,exports.checkMainPkgPageIsInSubpkg=checkMainPkgPageIsInSubpkg,exports.checkMainPkgPluginIsInSubPkg=checkMainPkgPluginIsInSubPkg,exports.checkComponentPath=checkComponentPath,exports.checkEntranceDeclare=checkEntranceDeclare,exports.mergeExtJSON=mergeExtJSON,exports.getAppJSONVariableDecalearProperty=getAppJSONVariableDecalearProperty;
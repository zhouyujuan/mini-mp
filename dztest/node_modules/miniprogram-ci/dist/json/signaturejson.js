"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAllPluginSignatures=exports.isPathValid=exports.getAllPluginsWithPath=exports.friendlyPathMake=exports.trailing=void 0;const path=require("path"),getGameJSON=require("./game"),fse=require("fs-extra"),tools_1=require("../utils/tools"),log=require("../utils/log"),trailing=(t,i)=>t.endsWith(i)?t:t+i;exports.trailing=trailing;const friendlyPathMake=(t,i)=>path.normalize(path.join(t,i.replace(/\\/g,"/")).replace(/^\/+/,""));async function getAllPluginsWithPath(t){const i=await getGameJSON(t),e=[],a=(t,i="")=>{if(t.plugins)for(const a in t.plugins){if(!t.plugins.hasOwnProperty(a))continue;const r=t.plugins[a];r&&"string"==typeof r.path&&e.push({alias:a,version:r.version||"",provider:r.provider||"",path:r.path,friendlyPath:exports.friendlyPathMake(i,r.path)})}};a(i,"");const r=i.subPackages||i.subpackages;if(Array.isArray(r))for(const t of r)t&&"string"==typeof t.root&&a(t,t.root);return e}function isPathValid(t,i){if(i=i.replace(/\\/g,"/"),t=t.replace(/\\/g,"/"),i.includes("../")||i.endsWith("/.."))return!1;const e=tools_1.normalizePath(path.join(t,i)),a=tools_1.normalizePath(t);return!!e.startsWith(a)}async function getAllPluginSignatures(t){const i=await getAllPluginsWithPath(t),e=[];let a=t.miniprogramRoot?path.join(t.projectPath,t.miniprogramRoot):t.projectPath;a=tools_1.normalizePath(a),a=a.endsWith("/")?a:a+"/";for(const t of i)try{const i=path.join(a,t.friendlyPath);let r=await fse.pathExists(i);if(!r)continue;const n=await fse.stat(i);let o=i;n.isDirectory()||(o=path.dirname(i));const s=path.join(o,"signature.json");if(r=await fse.pathExists(s),!r)continue;const l=await fse.readFile(s,"utf8");let h=null;try{h=JSON.parse(l)}catch(t){log.error(t);continue}if(!h||!Array.isArray(h.signature))continue;const p=[];for(let t=0;t<h.signature.length;t++){const i=h.signature[t];if(!i)continue;if("string"!=typeof i.path||"string"!=typeof i.md5)continue;if(!isPathValid(o,i.path))continue;const e=path.join(o,i.path);p.push({fullPath:e,md5:i.md5})}e.push({provider:t.provider,fullPath:i,signature:p})}catch(t){log.error(t);continue}return e}exports.friendlyPathMake=friendlyPathMake,exports.getAllPluginsWithPath=getAllPluginsWithPath,exports.isPathValid=isPathValid,exports.getAllPluginSignatures=getAllPluginSignatures;
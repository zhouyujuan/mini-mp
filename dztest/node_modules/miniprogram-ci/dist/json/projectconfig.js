"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getProjectConfigJSON=void 0;const lodash_1=require("lodash"),common_1=require("../utils/common"),common_2=require("./common"),{schemaValidate:schemaValidate}=require("../validate/schemaValidate"),cache_1=require("../utils/cache"),tools_1=require("../utils/tools"),config_1=require("../config"),locales=require("../utils/locales/locales"),reactiveCache_1=require("./reactiveCache"),PROJECT_CONFIG_JSON="project.config.json",rootConfig=["svr","client","qcloudRoot","miniprogramRoot","pluginRoot","cloudfunctionRoot","jsserverRoot","testRoot"];function formatPath(o=""){return o&&"/"!==o?(o=tools_1.normalizePath(o+"/")).replace(/^(\/)*/,"").replace(/\.\.\//g,"").replace(/^\.\//,""):""}const _getProjectConfigJSON=reactiveCache_1.wrapCompileJSONFunc(cache_1.CACHE_KEY.PROJECT_CONFIG,(function(o,e=!1){if(!o.stat("",PROJECT_CONFIG_JSON))return o.type!==config_1.COMPILE_TYPE.miniGamePlugin&&o.type!==config_1.COMPILE_TYPE.miniProgramPlugin||common_1.throwError({msg:locales.config.NOT_FOUND.format("project.config.json"),code:config_1.FILE_NOT_FOUND,filePath:PROJECT_CONFIG_JSON}),{};const r=o.getFile("",PROJECT_CONFIG_JSON),t=common_1.checkUTF8(r,PROJECT_CONFIG_JSON),i=common_2.checkJSONFormat(t,PROJECT_CONFIG_JSON),c=schemaValidate("projectconfig",i);if(c.error.length){const o=c.error.map(o=>"type"===o.errorType||"enum"===o.errorType||"anyOf"===o.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([o.errorProperty,o.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([o.requireProperty])).join("\n");common_1.throwError({msg:o,filePath:PROJECT_CONFIG_JSON})}return o.miniprogramRoot=i.miniprogramRoot||"",o.pluginRoot=i.pluginRoot||"",rootConfig.forEach(o=>{"string"==typeof i[o]?i[o]=formatPath(i[o]):i[o]=""}),o.type!==config_1.COMPILE_TYPE.miniGamePlugin&&o.type!==config_1.COMPILE_TYPE.miniProgramPlugin||i.pluginRoot||common_1.throwError({msg:locales.config.SHOULD_NOT_BE_EMPTY.format('["pluginRoot"]'),filePath:PROJECT_CONFIG_JSON}),i})),getProjectConfigJSON=function(o,e=!1){return lodash_1.cloneDeep(_getProjectConfigJSON(o,e))};exports.getProjectConfigJSON=getProjectConfigJSON;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getGameLocalPluginJSON=exports.getDevPluginJSON=exports.checkComponentPath=void 0;const path=require("path"),projectconfig_1=require("../projectconfig"),locales=require("../../utils/locales/locales"),common_1=require("../common"),config_1=require("../../config"),validateType=require("../../validate/pluginjson"),{schemaValidate:schemaValidate,NEW_CHECK_JSON_WAY:NEW_CHECK_JSON_WAY}=require("../../validate/schemaValidate"),tools_1=require("../../utils/tools"),cache_1=require("../../utils/cache"),common_2=require("../../utils/common"),common_3=require("../common"),reactiveCache_1=require("../reactiveCache");function checkComponentPath(o,e){const{project:t,root:c,filePath:n}=o;void 0!==e.usingComponents&&common_3.checkComponentPath({project:t,root:c,relativePath:path.posix.relative(c,n),inputJSON:e})}function checkPublicComponentsAndPages(o,e){const{project:t,root:c,filePath:n}=o,{publicComponents:i,pages:r}=e,a={};if(i){const o=[];for(const r in i){const i=e.publicComponents[r];common_2.checkPath({value:i,tips:`["publicComponents"]["${r}"]`,filePath:n,code:config_1.PLUGIN_JSON_CONTENT_ERR});let s=t.stat(c,i+".wxml");s&&!s.isDirectory||o.push(locales.config.CORRESPONDING_FILE_NOT_FOUND.format(`["publicComponents"]["${i}"]`,i+".wxml")),s=t.stat(c,i+".js"),s&&!s.isDirectory||o.push(locales.config.CORRESPONDING_FILE_NOT_FOUND.format(`["publicComponents"]["${i}"]`,i+".js")),s=t.stat(c,i+".json"),s&&!s.isDirectory||o.push(locales.config.CORRESPONDING_FILE_NOT_FOUND.format(`["publicComponents"]["${i}"]`,i+".json")),a[r]=!0}o.length>0&&common_2.throwError({msg:o.join("\n"),code:config_1.PLUGIN_JSON_CONTENT_ERR,filePath:n})}if(r){const o=[];for(const e in r){const i=r[e];common_2.checkPath({value:i,tips:`["pages"]["${e}"]`,filePath:n,code:config_1.PLUGIN_JSON_CONTENT_ERR});let s=t.stat(c,i+".wxml");s&&!s.isDirectory||o.push(locales.config.CORRESPONDING_FILE_NOT_FOUND.format(`["pages"]["${i}"]`,i+".wxml")),s=t.stat(c,i+".js"),s&&!s.isDirectory||o.push(locales.config.CORRESPONDING_FILE_NOT_FOUND.format(`["pages"]["${i}"]`,i+".js")),s=t.stat(c,i+".json"),s&&!s.isDirectory||o.push(locales.config.CORRESPONDING_FILE_NOT_FOUND.format(`["pages"]["${i}"]`,i+".json")),a[e]&&o.push(locales.config.SAME_KEY_PAGE_PUBLICCOMPONENTS.format(`"${e}"`)),a[e]=!0}o.length>0&&common_2.throwError({msg:o.join("\n"),code:config_1.PLUGIN_JSON_CONTENT_ERR,filePath:n})}}function checkMain(o,e){const{project:t,root:c,filePath:n}=o,{main:i}=e;if(void 0===i)return;""===i&&common_2.throwError({msg:locales.config.SHOULD_NOT_BE_EMPTY.format('["main"]'),code:config_1.PLUGIN_JSON_CONTENT_ERR,filePath:n}),common_2.checkPath({value:i,tips:'["main"]',filePath:n,code:config_1.PLUGIN_JSON_CONTENT_ERR});const r=t.stat(c,i);r&&!r.isDirectory||common_2.throwError({msg:locales.config.CORRESPONDING_FILE_NOT_FOUND.format('["main"]',i),code:config_1.PLUGIN_JSON_CONTENT_ERR,filePath:n})}function isKindOfGamePlugin(o){return o.type===config_1.COMPILE_TYPE.miniGamePlugin}function checkPluginJSON(o){const{root:e="",project:t}=o,c=path.posix.join(e,"plugin.json");t.stat(e,"plugin.json")||common_2.throwError({msg:locales.config.FILE_NOT_FOUND.format(c),code:config_1.PLUGIN_JSON_FILE_NOT_FOUND,filePath:c});const n=t.getFile(e,"plugin.json"),i=common_1.checkJSONFormat(common_2.checkUTF8(n,c),c);if(NEW_CHECK_JSON_WAY){const o=schemaValidate("plugin",i);if(o.error.length){const e=o.error.map(o=>"type"===o.errorType||"enum"===o.errorType||"anyOf"===o.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([o.errorProperty,o.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([o.requireProperty])).join("\n");common_2.throwError({msg:"pluginJSON$"+e,code:config_1.PLUGIN_JSON_CONTENT_ERR,filePath:c})}}else try{validateType.check(i)}catch(o){common_2.throwError({msg:"pluginJSON"+o.message,code:config_1.PLUGIN_JSON_CONTENT_ERR,filePath:c})}return void 0!==i.themeLocation&&common_2.checkPath({value:i.themeLocation,tips:'["themeLocation"]',filePath:c}),isKindOfGamePlugin(t)||(checkPublicComponentsAndPages(o,i),checkComponentPath(o,i)),checkMain(o,i),i}exports.checkComponentPath=checkComponentPath,exports.getDevPluginJSON=reactiveCache_1.wrapCompileJSONFunc(cache_1.CACHE_KEY.PLUGIN_JSON,(function(o,e=!0,t=""){const c=projectconfig_1.getProjectConfigJSON(o),{pluginRoot:n=""}=c;let i=n;o.type===config_1.COMPILE_TYPE.miniGame&&t&&(i=t),t||n||common_2.throwError({msg:locales.config.NOT_FOUND.format('["pluginRoot"]'),filePath:"project.config.json",code:config_1.JSON_CONTENT_ERR});return checkPluginJSON({project:o,filePath:path.posix.join(i,"plugin.json"),root:i})}));const getGameLocalPluginJSON=async(o,e)=>{const t=await projectconfig_1.getProjectConfigJSON(o),{miniprogramRoot:c}=t;if(!e)return{};const n=tools_1.normalizePath(path.posix.join(c||"",e));return checkPluginJSON({project:reactiveCache_1.tryToGetReactiveProject(o),filePath:path.posix.join(n,"plugin.json"),root:n})};exports.getGameLocalPluginJSON=getGameLocalPluginJSON;
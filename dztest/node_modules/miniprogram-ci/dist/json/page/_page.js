"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkPageJSON=void 0;const path=require("path"),locales=require("../../utils/locales/locales"),common_1=require("../common"),{schemaValidate:schemaValidate,NEW_CHECK_JSON_WAY:NEW_CHECK_JSON_WAY}=require("../../validate/schemaValidate"),tools_1=require("../../utils/tools"),common_2=require("../../utils/common"),theme_1=require("../theme"),checkHexColor=e=>{const{inputJSON:o,mode:a,pagePath:t,themeLocation:r}=e;let n=t+".json";if(o){r&&(n=`${t}.json or ${r}["${a}"]`);const{navigationBarBackgroundColor:e,backgroundColor:i}=o;void 0===e||tools_1.isHexColor(e)||common_2.throwError({msg:`["navigationBarBackgroundColor"]: "${e}" is not hexColor`,filePath:n}),void 0===i||tools_1.isHexColor(i)||common_2.throwError({msg:`["backgroundColor"]: "${i}" is not hexColor`,filePath:n})}};function _checkPageJSON(e){const{project:o,pagePath:a}=e;let t=e.filePath;if(!o.stat("",t))return{};const r=o.getFile("",t),n=common_1.checkJSONFormat(common_2.checkUTF8(r,t),t),i=theme_1.getThemeLocation(o);if(!i){const e=common_1.getPageJSONVariableDecalearProperty(n);e.length&&common_2.throwError({msg:'["themeLocation"] is required because:\n'+e.map(e=>`"${e.value}" as variable was declared at ${t}:${e.property}`).join("\n"),filePath:t})}let c={light:{},dark:{}};i&&(c=theme_1.checkThemeJSON(o,{themeLocation:i}));const l=theme_1.mergeThemeJSONToPageJSON(c,n,t),m=schemaValidate("page",l.pageJSONLight),h=schemaValidate("page",l.pageJSONDark),g=common_1.getPageJSONVariableDecalearProperty(l.pageJSONLight);g.length&&common_2.throwError({msg:g.map(e=>`"${e.value}" as variable was declared at ${t}:${e.property}, but not found at ${i}["light"]`).join("\n"),filePath:t});const s=common_1.getPageJSONVariableDecalearProperty(l.pageJSONDark);if(s.length&&common_2.throwError({msg:s.map(e=>`"${e.value}" as variable was declared at ${t}:${e.property}, but not found at ${i}["dark"]`).join("\n"),filePath:t}),m.warning&&(n.__warning__=locales.config.INVALID.format(m.warning)),i&&h.warning&&(n.__warning__=locales.config.INVALID.format(h.warning)),m.error.length){const e=common_1.transValidateResult(m);i&&(t+=` or ${i}["light"]`),common_2.throwError({msg:e,filePath:t})}if(i&&h.error.length){const e=common_1.transValidateResult(h);i&&(t+=` or ${i}["dark"]`),common_2.throwError({msg:e,filePath:t})}return checkHexColor({inputJSON:l.pageJSONLight,mode:"light",themeLocation:i||"",filePath:t,pagePath:a}),checkHexColor({inputJSON:l.pageJSONDark,mode:"dark",themeLocation:i||"",filePath:t,pagePath:a}),n}function checkPageJSON(e,o){const{pagePath:a,miniprogramRoot:t="",useCache:r=!0}=o;return _checkPageJSON({project:e,miniprogramRoot:t,pagePath:a,filePath:tools_1.normalizePath(path.posix.join(t,a+".json"))})}exports.checkPageJSON=checkPageJSON;
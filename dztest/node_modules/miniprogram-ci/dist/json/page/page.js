"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getPageJSON=exports.originGetPageJSON=void 0;const path=require("path"),lodash_1=require("lodash"),ext_1=require("../app/ext"),app_merge_ext_1=require("../app/app_merge_ext"),tools_1=require("../../utils/tools"),_page_1=require("./_page"),common_1=require("../common"),common_2=require("../../utils/common"),locales=require("../../utils/locales/locales"),reactiveCache_1=require("../reactiveCache"),spreadUsingComponent=e=>{const{project:t,pagePath:o,inputJSON:n}=e;if(o.includes("miniprogram_npm"))return;const i=app_merge_ext_1.getAppJSON(t);if(common_1.checkPagePathIsInIndependentSubpackage(i,o))return;const a=Object.assign({},i.usingComponents);if(0!==Object.keys(a).length){n.usingComponents||(n.usingComponents={});for(const e in a){if(n.usingComponents[e])continue;const t=a[e]||"";if(t.startsWith("/")||t.startsWith("plugin://")){n.usingComponents[e]=t;continue}const i=tools_1.normalizePath(path.posix.relative(path.posix.dirname(o),t));n.usingComponents[e]=i.startsWith(".")?i:"./"+i}}},mergeExtJSON=e=>{const{project:t,inputJSON:o,pagePath:n}=e,i=ext_1.getExtJSON(t,!0);i&&i.extPages&&i.extPages[n]&&Object.assign(o,i.extPages[n])},checkComponentPath=e=>{const{project:t,miniprogramRoot:o,pagePath:n,inputJSON:i}=e;common_1.checkComponentPath({project:t,root:o,relativePath:n+".json",inputJSON:i})},checkComponentGenerics=e=>{const{pagePath:t,inputJSON:o}=e,n=t+".json";if(!o.componentGenerics)return;const i=[];for(const e in o.componentGenerics){const t=o.componentGenerics[e],n=tools_1.getType(t);"boolean"===n||"object"===n?"object"===n&&"string"!==tools_1.getType(t.default)&&i.push(locales.config.JSON_CONTENT_SHOULD_BE.format([`["componentGenerics"]["${e}"]["default"]`,"string"])):i.push(locales.config.JSON_CONTENT_SHOULD_BE.format([`["componentGenerics"]["${e}"]`,"boolean/object"]))}i.length>0&&common_2.throwError({msg:i.join("\n"),filePath:n})},compilePageJSON=e=>{mergeExtJSON(e),checkComponentGenerics(e),checkComponentPath(e),spreadUsingComponent(e)};function originGetPageJSON(e,t){const{pagePath:o,miniprogramRoot:n="",useCache:i=!0}=t,a=tools_1.normalizePath(path.posix.join(n,o+".json")),r=reactiveCache_1.tryToGetReactiveJSONCompiler(e),c=lodash_1.cloneDeep(r.getPageJSON("checked",t));return compilePageJSON({project:e,miniprogramRoot:n,inputJSON:c,filePath:a,pagePath:o}),c.usingComponents||(c.usingComponents={}),c}async function getPageJSON(e,t){const o=reactiveCache_1.tryToGetReactiveProject(e);return reactiveCache_1.tryToGetReactiveJSONCompiler(o).getPageJSON("compiled",t)}exports.originGetPageJSON=originGetPageJSON,reactiveCache_1.ReactiveJSONCompiler.setOriginCheckPageJSON(_page_1.checkPageJSON),reactiveCache_1.ReactiveJSONCompiler.setOriginGetPageJSON(originGetPageJSON),exports.getPageJSON=getPageJSON;
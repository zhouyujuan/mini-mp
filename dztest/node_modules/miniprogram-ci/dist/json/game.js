"use strict";const cache_1=require("../utils/cache"),common_1=require("../utils/common"),config_1=require("../config"),tools_1=require("../utils/tools"),path=require("path"),locales=require("../utils/locales/locales"),projectconfig_1=require("./projectconfig"),common_2=require("./common"),{schemaValidate:schemaValidate,NEW_CHECK_JSON_WAY:NEW_CHECK_JSON_WAY}=require("../validate/schemaValidate"),signatureValidate=require("../validate/signaturejson"),gamePluginJSONValidate=require("../validate/gamepluginjson"),reactiveCache_1=require("./reactiveCache");function isPluginMode(o){return o.type===config_1.COMPILE_TYPE.miniGamePlugin}function checkLocalPlugin(o,t){const{project:e,root:a,filePath:r}=o,i=t.path;let n=e.stat(a,i);n&&n.isDirectory||common_1.throwError({msg:locales.config.JSON_CONTENT_SHOULD_BE.format(t.tips+'["path"]',locales.config.DIRECTORY),filePath:r});const c=path.posix.join(i,"signature.json");n=e.stat(a,c);let s=tools_1.normalizePath(path.posix.join(a,c));n||common_1.throwError({msg:locales.config.CORRESPONDING_FILE_NOT_FOUND.format(t.tips+'["path"]',s),filePath:r,code:config_1.FILE_NOT_FOUND});let _=e.getFile(a,c),l=common_1.checkUTF8(_,s);const m=common_2.checkJSONFormat(l,s);try{signatureValidate.check(m)}catch(o){common_1.throwError({msg:"signature.json"+o.message,filePath:s})}m.provider!==t.provider&&common_1.throwError({msg:locales.config.JSON_CONTENT_SHOULD_BE.format('["provider"]',`"${t.provider}"`),filePath:s});for(let o=0;o<m.signature.length;o++){const t=m.signature[o];common_1.checkPath({value:t.path,tips:`["signature"][${o}]["path"]`,filePath:s});const r=path.posix.join(i,t.path);n=e.stat(a,r),n&&n.isFile||common_1.throwError({msg:locales.config.CORRESPONDING_FILE_NOT_FOUND.format(`["signature"][${o}]["path"]`,r),filePath:s,code:config_1.FILE_NOT_FOUND});const c=e.getFile(a,r),_=tools_1.generateMD5(c);_!==t.md5&&common_1.throwError({msg:locales.config.GAME_PLUGIN_SIGNATURE_MD5_NOT_MATCH_CONTENT.format(path.posix.join(i,t.path),_,t.md5),code:config_1.GAME_PLUGIN_LIB_MD5_NOT_MATCH,filePath:s})}const h=path.posix.join(i,"plugin.json");n=e.stat(a,h),s=tools_1.normalizePath(path.posix.join(a,h)),n||common_1.throwError({msg:locales.config.CORRESPONDING_FILE_NOT_FOUND.format(t.tips+'["path"]',s),code:config_1.FILE_NOT_FOUND,filePath:r}),_=e.getFile(a,h),l=common_1.checkUTF8(_,s);const g=common_2.checkJSONFormat(l,s);try{gamePluginJSONValidate.check(g)}catch(o){common_1.throwError({msg:"plugin.json"+o.message,filePath:s})}g.main&&(common_1.checkPath({value:g.main,tips:'["main"]',filePath:s}),n=e.stat(a,path.posix.join(i,g.main)),n||common_1.throwError({msg:locales.config.CORRESPONDING_FILE_NOT_FOUND.format('["main"]',""+g.main),filePath:s,code:config_1.FILE_NOT_FOUND}))}function checkPluginPath(o,t){const{plugins:e,subPackages:a}=t,r=[],i=(o,t,e)=>{const{plugins:a}=o;if(a)for(const o in a){if(!a.hasOwnProperty(o))continue;const i=a[o];i&&i.path&&r.push({alias:o,version:i.version||"",provider:i.provider||"",tips:`${e}["plugins"]["${o}"]`,path:tools_1.normalizePath(path.posix.join(t,i.path))})}};if(i(t,"",""),a)for(let o=0;o<a.length;o++){const t=a[o];i(t,t.root||"",`["subPackages"][${o}]`)}if(!(r.length<=0))for(const t of r)checkLocalPlugin(o,t)}function checkPlugins(o,t){const{project:e,filePath:a}=o,r=[],i=t.plugins||{};function n(o,t){const i=e.appid,n=isPluginMode(e);if(n||"dev"!==o.version)if(n&&"dev"===o.version&&o.provider!==i)r.push(locales.config.JSON_CONTENT_SHOULD_BE.format(t+'["provider"]',i));else if("dev"!==o.version||"string"!=typeof o.path){if("dev"===o.version||"latest"===o.version||/^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/.test(o.version)||/^dev-[A-Za-z0-9]+$/.test(o.version))return o.path&&common_1.checkPath({value:o.path,tips:t+'["path"]',filePath:a}),!0;r.push(locales.config.JSON_CONTENT_SHOULD_BE.format(t+'["version"]',locales.config.TRIPLE_NUMBER_DOT))}else r.push(locales.config.GAME_DEV_PLUGIN_SHOULD_NOT_USE_LOCAL_PATH.format(t,t+'["path"]'));else r.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format(t+'["version"]',"dev")+"\n"+locales.config.PLEASE_CHOOSE_PLUGIN_MODE)}const c={},s={};for(const o in i){if(!i.hasOwnProperty(o))continue;const t=i[o];n(t,`["plugins"]["${o}"]`)&&(c[t.provider]?r.push(locales.config.SAME_ITEM.format(`["plugins"]["${o}"]`,c[t.provider].tips,"provider")):c[t.provider]=s[o]={provider:t.provider,version:t.version,alias:o,path:t.path||"",tips:`["plugins"]["${o}"]`})}const _=t.subPackages||t.subpackages;if(Array.isArray(_))for(let o=0,t=_.length;o<t;o++){const t=_[o];if(!t.plugins)continue;const e=`["subPackages"][${o}]["plugins"]`;for(const o in t.plugins){const a=t.plugins[o],i=`${e}["${o}"]`;n(a,i)&&(c[a.provider]?r.push(locales.config.SAME_ITEM.format(i,c[a.provider].tips,"provider")):s[o]?r.push(locales.config.PLUGINS_SAME_ALIAS.format(i,s[o].tips)):c[a.provider]=s[o]={provider:a.provider,version:a.version,alias:o,path:a.path||"",tips:i})}}r.length>0&&common_1.throwError({msg:r.join("\n"),filePath:a})}function checkSubpackages(o,t){const{root:e,project:a,filePath:r}=o,i=[];let n='["subPackages"]';if(t.subpackages&&(n='["subpackages"]',t.subPackages=t.subpackages,delete t.subpackages),t.subPackages){const o=a.attrSync(),{setting:c}=o;t.subPackages.length>c.MaxSubPackageLimit&&common_1.throwError({msg:locales.config.EXCEED_LIMIT.format([n,c.MaxSubPackageLimit]),filePath:r});const s={},_={};for(let o=0,r=t.subPackages.length;o<r;o++){const r=t.subPackages[o];if(r.name){if(r.name===config_1.MINI_PROGRAM_MAIN_PACKAGE_ROOT){i.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format(`${n}[${o}]["name"]`,config_1.MINI_PROGRAM_MAIN_PACKAGE_ROOT));continue}if(r.name===config_1.MINI_GAME_MAIN_PACKAGE_ROOT){i.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format(`${n}[${o}]["name"]`,config_1.MINI_GAME_MAIN_PACKAGE_ROOT));continue}s[r.name]&&i.push(locales.config.SAME_ITEM.format(`${n}[${o}]`,s[r.name],"name")),s[r.name]=`${n}[${o}]`}if(r.root===config_1.MINI_PROGRAM_MAIN_PACKAGE_ROOT){i.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format(`${n}[${o}]["root"]`,config_1.MINI_PROGRAM_MAIN_PACKAGE_ROOT));continue}if(r.root===config_1.MINI_GAME_MAIN_PACKAGE_ROOT){i.push(locales.config.JSON_CONTENT_SHOULD_NOT_BE.format(`${n}[${o}]["root"]`,config_1.MINI_GAME_MAIN_PACKAGE_ROOT));continue}if(r.root.startsWith(".")){i.push(locales.config.JSON_SHOULD_NOT_START_WITH.format(`${n}[${o}]["root"]`,"."));continue}if(r.root.startsWith("__wx__")){i.push(locales.config.JSON_SHOULD_NOT_START_WITH.format(`${n}[${o}]["root"]`,"__wx__"));continue}r.root.startsWith("/")||(r.root=tools_1.normalizePath("/"+r.root)),/\.js$/.test(r.root)?r.root=tools_1.normalizePath(r.root):r.root=tools_1.normalizePath(r.root+"/"),_[r.root]&&i.push(locales.config.SAME_ITEM.format(`${n}[${o}]`,_[r.root],"root")),_[r.root]=`${n}[${o}]`;const c=a.stat(e,r.root);if(c){if(c.isDirectory){/\/$/.test(r.root)||(r.root+="/");const t=path.posix.join(r.root,"./game.js"),c=a.stat(e,t);c&&c.isFile||i.push(locales.config.CORRESPONDING_FILE_NOT_FOUND.format(`${n}[${o}]["root"]`,t))}}else i.push(locales.config.JSON_CONTENT_NOT_FOUND.format(`${n}[${o}]["root"]`))}}i.length>0&&common_1.throwError({msg:i.join("\n"),filePath:r})}function checkLoadingImageUrl(o,t){const{project:e,root:a,filePath:r}=o,{loadingImageInfo:i}=t;if(!i)return;common_1.checkPath({tips:'["loadingImageInfo"]["path"]',value:i.path,filePath:r});const n=e.stat(a,i.path);n&&n.isFile||common_1.throwError({msg:locales.config.JSON_CONTENT_NOT_FOUND.format(`["loadingImageInfo"]["path"]: "${i.path}"`),filePath:r}),i.progressBarColor&&!tools_1.isHexColor(i.progressBarColor)&&common_1.throwError({msg:locales.config.JSON_CONTENT_SHOULD_BE.format(`["loadingImageInfo"]["progressBarColor"]: "${i.progressBarColor}"`,"HexColor"),filePath:r})}function checkWorkers(o,t){const{project:e,root:a,filePath:r}=o,{workers:i}=t;if(void 0===i)return;common_1.checkPath({tips:'["workers"]',value:i,filePath:r});const n=e.stat(a,i);n&&!n.isFile||common_1.throwError({msg:locales.config.JSON_CONTENT_SHOULD_BE.format(['["workers"]',locales.config.DIRECTORY]),filePath:r})}function checkOpenDataContext(o,t){const{project:e,root:a,filePath:r}=o,{openDataContext:i}=t;if(void 0===i)return;common_1.checkPath({value:i,tips:'["openDataContext"]',filePath:r});const n=e.stat(a,i);n&&n.isDirectory||common_1.throwError({msg:locales.config.JSON_CONTENT_SHOULD_BE.format(['["openDataContext"]',locales.config.DIRECTORY]),filePath:r});const c=path.posix.join(i,"./index.js"),s=e.stat(a,c);s&&s.isFile||common_1.throwError({msg:locales.config.CORRESPONDING_FILE_NOT_FOUND.format('["openDataContext"]',c),filePath:r}),t.openDataContext=tools_1.normalizePath(i+"/")}function checkGameJSON(o){const{project:t,root:e,filePath:a}=o;t.stat(e,"game.json")||common_1.throwError({msg:locales.config.FILE_NOT_FOUND.format(path.posix.join(a)),filePath:a,code:config_1.FILE_NOT_FOUND});const r=t.getFile(e,"game.json"),i=common_2.checkJSONFormat(common_1.checkUTF8(r,a),a),n=schemaValidate("game",i);if(n.warning&&(i.__warning__=locales.config.INVALID.format(n.warning)),n.error.length){const o=n.error.map(o=>"type"===o.errorType||"enum"===o.errorType||"anyOf"===o.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([o.errorProperty,o.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([o.requireProperty])).join("\n");common_1.throwError({msg:o,filePath:a})}return checkOpenDataContext(o,i),checkPlugins(o,i),checkSubpackages(o,i),checkPluginPath(o,i),checkLoadingImageUrl(o,i),checkWorkers(o,i),i}const getGameJSON=reactiveCache_1.wrapCompileJSONFunc(cache_1.CACHE_KEY.GAME_JSON,(function(o,t=!0){const e=projectconfig_1.getProjectConfigJSON(o).miniprogramRoot||"";return checkGameJSON({project:o,root:e,filePath:tools_1.normalizePath(path.posix.join(e,"game.json"))})}));module.exports=getGameJSON;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compile=void 0;const common_1=require("./common"),mpjson_1=require("./handler/mpjson"),white_ext_list_1=require("../utils/white_ext_list"),config_1=require("../config"),common_2=require("../utils/common"),path=require("path"),projectconfig_1=require("../json/projectconfig"),locales=require("../utils/locales/locales"),uglifyfilenames_1=require("../utils/uglifyfilenames");async function compile(i,o){var e;const t=await projectconfig_1.getProjectConfigJSON(i,!1),r=t.miniprogramRoot||"";(await i.attr()).gameApp&&common_2.throwError({filePath:"",msg:locales.config.PROJECT_TYPE_ERROR.format(i.appid,locales.config.MINI_GAME),code:config_1.PROJECT_TYPE_ERROR});const{MiniProgramWhiteList:n}=await white_ext_list_1.getWhiteExtList(),a=i.getFileList(r,"").filter(common_1.isNotIgnoredByProjectConfig.bind(null,t,r)).filter(i=>n.has(path.posix.extname(i))),m=await mpjson_1.compileJSON(i,o),s=a.filter(i=>".js"===path.posix.extname(i)).map(i=>path.posix.relative(r,i)),c=await common_1.compileJSFiles(i,s,r,o),l=a.filter(i=>".wxss"===path.posix.extname(i)).map(i=>path.posix.relative(r,i)),p=await common_1.compileWXSSFiles(i,l,r,o),_=a.filter(i=>".wxml"===path.posix.extname(i)).map(i=>path.posix.relative(r,i)),g=await common_1.compileWXMLFiles(i,_,r,o),f=a.filter(i=>{const o=path.posix.extname(i);return".js"!==o&&".json"!==o&&".wxss"!==o&&".wxml"!==o}),u=await common_1.compileOther(i,f,o);let x=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},m),c),u),p),g);if(i.type===config_1.COMPILE_TYPE.miniProgram){if(t.miniprogramRoot&&"."!==t.miniprogramRoot&&"./"!==t.miniprogramRoot){const o={};for(const e in x)o[path.posix.relative(i.miniprogramRoot,e)]=x[e];x=o}x["project.config.json"]=JSON.stringify({miniprogramRoot:"",__compileDebugInfo__:o.__compileDebugInfo__||{}})}else x["project.config.json"]=JSON.stringify({miniprogramRoot:i.miniprogramRoot||"",__compileDebugInfo__:o.__compileDebugInfo__||{}});return i.type===config_1.COMPILE_TYPE.miniProgram&&(null===(e=o.setting)||void 0===e?void 0:e.codeProtect)&&(x=await uglifyfilenames_1.uglifyFileNames(i,x)),x}exports.compile=compile;
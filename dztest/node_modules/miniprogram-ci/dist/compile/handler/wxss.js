"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compileWXSS=void 0;const path=require("path"),tools_1=require("../../utils/tools"),locales=require("../../utils/locales/locales"),config_1=require("../../config"),taskstatus_1=require("../../utils/taskstatus"),worker_thread_1=require("../../worker_thread"),common_1=require("../../utils/common"),tools_2=require("../../utils/tools");async function compileWXSS(e,o,t){const{root:r="",setting:s={},onProgressUpdate:i=(()=>{}),devToolsCompileCache:a}=t,{minify:c,minifyWXSS:l,autoPrefixWXSS:n}=s,_=new taskstatus_1.TaskStatus(o),u=path.posix.join(r,o),d=await e.getFile(r,o);if(!c&&!l&&!n){i(_);const e=tools_1.bufferToUtf8String(d);return void 0===e&&common_1.throwError({msg:locales.config.FILE_NOT_UTF8.format(u),code:config_1.FILE_NOT_UTF8,filePath:u}),_.done(),i(_),{filePath:o,code:e}}async function f(){const t=await worker_thread_1.runTask(worker_thread_1.TASK_NAME.COMPILE_WXSS,{projectPath:e.projectPath,root:r,filePath:o,setting:s,code:d},e=>{e===worker_thread_1.ETaskStatus.progress?i(_):e===worker_thread_1.ETaskStatus.done&&(_.done(),i(_))});return t.error&&common_1.throwError({msg:t.error.message,code:t.error.code,filePath:u}),t.code}let h="";if(a){const t=tools_2.normalizePath(path.posix.join(e.projectPath,r,o)),i=`${t}_${JSON.stringify(s)}`;h=await a.getFile(t,i),h&&!s.codeProtect||(h=await f(),a.setFile(t,h,i))}else h=await f();return{filePath:o,code:h}}exports.compileWXSS=compileWXSS;
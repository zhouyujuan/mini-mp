"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compileJS=void 0;const path=require("path"),taskstatus_1=require("../../utils/taskstatus"),worker_thread_1=require("../../worker_thread"),common_1=require("../../utils/common"),config_1=require("../../config"),tools_1=require("../../utils/tools"),app_merge_ext_1=require("../../json/app/app_merge_ext"),common_2=require("../../json/common"),projectconfig_1=require("../../json/projectconfig");async function formatBabelRoot(e,t,o,r){if(e.type===config_1.COMPILE_TYPE.miniProgram){const t=await app_merge_ext_1.getAppJSON(e,!0),a=common_2.checkPagePathIsInIndependentSubpackage(t,o);a&&(r=`${a.root}/${r}`),"object"==typeof t.functionalPages&&!0===t.functionalPages.independent&&o.startsWith("functional-pages/")&&(r="functional-pages/"+r)}return tools_1.normalizePath(""+r)}async function compileJS(e,t,o){const{setting:r={},onProgressUpdate:a=(()=>{}),root:i="",devToolsCompileCache:n}=o,s=path.posix.join(i,t);let c=[],p=o.babelRoot||"@babel/runtime";if(r.es7){const o=await projectconfig_1.getProjectConfigJSON(e);c=o.setting&&o.setting.babelSetting&&o.setting.babelSetting.ignore||[],p=await formatBabelRoot(e,i,t,p)}const l=new taskstatus_1.TaskStatus(t),_=await e.getFile(i,t);async function g(){const o=await worker_thread_1.runTask(worker_thread_1.TASK_NAME.COMPILE_JS,{projectPath:e.projectPath,root:i,filePath:t,setting:r,code:_,babelRoot:p,babelIgnore:c},e=>{e===worker_thread_1.ETaskStatus.progress?a(l):e===worker_thread_1.ETaskStatus.done&&(l.done(),a(l))});return o.error&&common_1.throwError({msg:o.error.message,code:o.error.code,filePath:s}),o}let u={};if(n){const o=tools_1.normalizePath(path.posix.join(e.projectPath,i,t)),a=`${o}_${JSON.stringify(r)}`;u=await n.getFile(o,a),u&&!r.codeProtect||(u=await g(),n.setFile(o,u,a))}else u=await g();return Object.assign({filePath:t},u)}exports.compileJS=compileJS;
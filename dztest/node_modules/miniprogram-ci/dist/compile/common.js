"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getUploadProjectConfig=exports.compileWXMLFiles=exports.compileWXSSFiles=exports.compileJSFiles=exports.compileOther=exports.isNotIgnoredByProjectConfig=exports.getBabelRoot=void 0;const babel_helper_1=require("../utils/babel_helper"),js_1=require("./handler/js"),wxss_1=require("./handler/wxss"),wxml_1=require("./handler/wxml"),tools_1=require("../utils/tools"),taskstatus_1=require("../utils/taskstatus"),index_1=require("../worker_thread/index"),path=require("path"),projectconfig_1=require("../json/projectconfig"),getGameJSON=require("../json/game"),signaturejson_1=require("../json/signaturejson"),config_1=require("../config");async function getBabelRoot(o){const e=await projectconfig_1.getProjectConfigJSON(o);let t=e&&e.setting&&e.setting.babelSetting&&e.setting.babelSetting.outputPath;return t?(t=tools_1.normalizePath(t),t.replace(/(^[\.\/\\])|(\/$)/g,""),t):"@babel/runtime"}function isNotIgnoredByProjectConfig(o,e,t){const i=o.packOptions&&o.packOptions.ignore||[];return 0===i.length||!tools_1.isFileIgnored(path.posix.relative(e,t),i)}async function copyFile(o,e){return{filePath:e,code:await o.getFile("",e)}}async function compileOther(o,e,t){const{onProgressUpdate:i=(()=>{})}=t,s=new taskstatus_1.TaskStatus("compiling other files");i(s);const n=[];for(const t of e)n.push(copyFile(o,t));const r=await Promise.all(n),a={};for(const o of r){const{code:e,filePath:t}=o;e&&(a[t]=e)}return s.done(),i(s),a}async function canWeCompileJS(o,e,t){let i;for(const o of e)if(tools_1.normalizePath(t).startsWith(tools_1.normalizePath(signaturejson_1.trailing(o.fullPath,"/")))){i=o;break}if(i){return i.signature.findIndex(o=>tools_1.normalizePath(o.fullPath)===tools_1.normalizePath(t))>=0}return!0}async function compileJSFiles(o,e,t,i){const{setting:s={}}=i;let n="@babel/runtime";s.es7&&(n=await getBabelRoot(o));const r=[];if(o.type===config_1.COMPILE_TYPE.miniGame||o.type===config_1.COMPILE_TYPE.miniGamePlugin){const s=await signaturejson_1.getAllPluginSignatures(o);for(const a of e){const e=path.join(o.projectPath,t,a);await canWeCompileJS(o,s,e)&&r.push(js_1.compileJS(o,a,Object.assign(Object.assign({},i),{babelRoot:n,root:t})))}}else for(const s of e)r.push(js_1.compileJS(o,s,Object.assign(Object.assign({},i),{babelRoot:n,root:t})));let a=[];try{a=await Promise.all(r)}catch(o){throw index_1.abortTask(index_1.TASK_NAME.COMPILE_JS),o}const l={},c=new Set;for(const o of a){const{filePath:e,map:i,code:s,helpers:n}=o,r=tools_1.formatSourceMap(i);void 0!==s&&(l[path.posix.normalize(path.posix.join(t,e))]=s),r&&(l[path.posix.normalize(path.posix.join(t,e+".map"))]=r),n.length>0&&n.forEach(o=>{c.add(o)})}return await babel_helper_1.appendBabelHelpers(c,path.join(t),n,l),l}async function compileWXSSFiles(o,e,t,i){const s=[];for(const n of e)s.push(wxss_1.compileWXSS(o,n,Object.assign(Object.assign({},i),{root:t})));let n=[];try{n=await Promise.all(s)}catch(o){throw index_1.abortTask(index_1.TASK_NAME.COMPILE_WXSS),o}const r={};for(const o of n){const{filePath:e,code:i,helpers:s}=o;void 0!==i&&(r[path.posix.normalize(path.posix.join(t,e))]=i)}return r}async function compileWXMLFiles(o,e,t,i){const s=[];for(const n of e)s.push(wxml_1.compileWXML(o,n,Object.assign(Object.assign({},i),{root:t})));let n=[];try{n=await Promise.all(s)}catch(o){throw index_1.abortTask(index_1.TASK_NAME.MINIFY_WXML),o}const r={};for(const o of n){const{filePath:e,code:i,helpers:s}=o;void 0!==i&&(r[path.posix.normalize(path.posix.join(t,e))]=i)}return r}async function getUploadProjectConfig(o,e){const t={miniprogramRoot:e.miniprogramRoot,localPlugins:[]};e.pluginRoot&&(t.pluginRoot=e.pluginRoot);const i=await getGameJSON(o,!0),s=(o,e="")=>{const i=t.localPlugins||[];for(const t in o)if(o.hasOwnProperty(t)&&o[t]&&"string"==typeof o[t].path){const s=o[t],n=path.posix.normalize(path.posix.join(e,s.path.replace(/\\/g,"/")).replace(/^\/+/,""));i.push({alias:t,provider:s.provider,path:n})}t.localPlugins=i};if(i.plugins){s(i.plugins)}const n=i.subpackages||i.subPackages;if(Array.isArray(n))for(const o of n)o&&o.plugins&&s(o.plugins,o.root||"");return t}exports.getBabelRoot=getBabelRoot,exports.isNotIgnoredByProjectConfig=isNotIgnoredByProjectConfig,exports.compileOther=compileOther,exports.compileJSFiles=compileJSFiles,exports.compileWXSSFiles=compileWXSSFiles,exports.compileWXMLFiles=compileWXMLFiles,exports.getUploadProjectConfig=getUploadProjectConfig;
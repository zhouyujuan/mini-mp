"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compile=exports.compilePlugin=void 0;const mini_program_1=require("./mini_program"),common_1=require("./common"),plugin_1=require("../json/plugin/plugin"),plugin_page_1=require("../json/plugin/plugin_page"),white_ext_list_1=require("../utils/white_ext_list"),path=require("path"),projectconfig_1=require("../json/projectconfig");async function compilePlugin(i,e){const t=await projectconfig_1.getProjectConfigJSON(i),{MiniProgramWhiteList:o}=await white_ext_list_1.getWhiteExtList(),n=t.pluginRoot,p=i.getFileList(n,"").filter(common_1.isNotIgnoredByProjectConfig.bind(null,t,n)).filter(i=>o.has(path.posix.extname(i))),s=await plugin_1.getDevPluginJSON(i,!1),a=p.filter(i=>".json"===path.posix.extname(i)&&i!==path.posix.join(n,"plugin.json")),r={};for(const e of a){const t=await plugin_page_1.getPluginPageJSON({project:i,root:n,filePath:e});r[e]=JSON.stringify(t)}const l=p.filter(i=>".js"===path.posix.extname(i)).map(i=>path.posix.relative(n,i)),c=await common_1.compileJSFiles(i,l,n,e),g=p.filter(i=>".wxss"===path.posix.extname(i)).map(i=>path.posix.relative(n,i)),m=await common_1.compileWXSSFiles(i,g,n,e),u=p.filter(i=>".wxml"===path.posix.extname(i)).map(i=>path.posix.relative(n,i)),_=await common_1.compileWXMLFiles(i,u,n,e),j=p.filter(i=>{const e=path.posix.extname(i);return".js"!==e&&".json"!==e&&".wxss"!==e&&".wxml"!==e}),x=await common_1.compileOther(i,j,e);return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({[path.posix.join(n,"plugin.json")]:JSON.stringify(s)},r),c),x),m),_)}async function compile(i,e){const t=await projectconfig_1.getProjectConfigJSON(i,!1),o=await compilePlugin(i,e),n=await mini_program_1.compile(i,e);return Object.assign(Object.assign(Object.assign({},o),n),{"project.config.json":JSON.stringify({miniprogramRoot:t.miniprogramRoot,pluginRoot:t.pluginRoot,__compileDebugInfo__:e.__compileDebugInfo__||{}})})}exports.compilePlugin=compilePlugin,exports.compile=compile;
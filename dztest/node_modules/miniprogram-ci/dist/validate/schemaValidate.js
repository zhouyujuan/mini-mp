"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NEW_CHECK_JSON_WAY=exports.schemaValidate=exports.config=void 0;const url_config_1=require("../utils/url_config"),log=require("../utils/log"),request_1=require("../utils/request"),jsonschema_1=require("jsonschema"),validator=new jsonschema_1.Validator,app=require("../schema/dist/app.js"),ext=require("../schema/dist/ext.js"),game=require("../schema/dist/game.js"),page=require("../schema/dist/page.js"),plugin=require("../schema/dist/plugin.js"),pluginpage=require("../schema/dist/pluginpage.js"),projectconfig=require("../schema/dist/projectconfig.js"),sitemap=require("../schema/dist/sitemap.js"),theme=require("../schema/dist/theme.js"),jsonParse_1=require("../utils/jsonParse");exports.config={app:app,ext:ext,game:game,page:page,plugin:plugin,pluginpage:pluginpage,projectconfig:projectconfig,sitemap:sitemap,theme:theme};const SchemaMap=Object.assign({},exports.config),schemaValidate=(e,r)=>{const a=validator.validate(r,SchemaMap[e]).errors,t=a.filter(e=>"additionalProperties"===e.name),i=a.filter(e=>"additionalProperties"!==e.name).map(e=>{if("type"===e.name||"enum"===e.name||"anyOf"===e.name){let r=e.argument;if("string"==typeof r&&(r=[r]),"anyOf"===e.name){r=[(e.schema.anyOf||[]).map(e=>e.type).join(", ")]}const a=e.property.replace(/^instance\.?/,"");return{errorType:e.name,errorProperty:a,correctType:r}}return{errorType:e.name,errorProperty:e.property.replace(/^instance\.?/,""),requireProperty:e.argument}});return{warning:t.map(r=>{const a=r.property.replace(/^instance\.?/,"");return`${e}.json ${a.length?a:""}["${r.argument}"]`}).join("、")||"",error:i}};function mergeOnlineConfig(e){for(const r in e)try{SchemaMap.hasOwnProperty(r)&&e[r].$version>SchemaMap[r].$version&&(SchemaMap[r]=e[r])}catch(e){log.error(e)}}async function getOnlineSchema(){try{const{body:e}=await request_1.request({url:url_config_1.GET_ONLINE_SCHEMA,method:"get"}),r=jsonParse_1.jsonRespParse(e,url_config_1.GET_ONLINE_SCHEMA);if(0===r.errCode&&r.data)return r.data}catch(e){log.error("get online schema fail "+e)}return{}}exports.schemaValidate=schemaValidate,exports.NEW_CHECK_JSON_WAY=!0,getOnlineSchema().then(e=>{mergeOnlineConfig(e)}).catch(e=>{});
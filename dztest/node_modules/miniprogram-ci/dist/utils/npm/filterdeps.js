"use strict";const path=require("path"),readPackageTree=require("read-package-tree");function checkDeps(e,t){const a=new Set(Object.keys(e.package&&e.package.dependencies||{})),n=[];let r=e;for(;r;){const e=r.children||[];for(const t of e){const e=t.package&&t.package.name||"";a.has(e)&&(a.delete(e),n.push(t))}r=r.parent}for(const e of n)t.has(e)||(t.add(e),checkDeps(e,t))}async function getDeps(e){return new Promise((t,a)=>{readPackageTree(e,(e,n)=>{if(e)return a(e);const r=new Set;try{checkDeps(n,r)}catch(e){return a(e)}t(Array.from(r))})})}module.exports=async function(e,t){if(t&&t.length){const a=t.filter(e=>!/([\\\/]|\b)node_modules/.test(e)),n=[],r={};for(const t of a){(await getDeps(path.join(e,path.dirname(t)))).forEach(e=>{n.push(e)})}for(const e of n){const t=e.isLink?e.path:e.realpath;r[path.normalize(path.join(t,"./package.json"))]=e}t=t.filter(t=>{const a=path.normalize(path.join(e,t));return!!r[a]})}return t};